# 502 Bad Gateway와 이메일/닉네임 검증 실패

## 현상

- 회원가입 시 이메일·닉네임 검증 API 호출이 **HTTP 502 (Bad Gateway)** 로 실패
- 화면에 "확인할 수 없습니다. 잠시 후 다시 시도해주세요." 또는 이메일 검사 실패 메시지 표시

## 502가 의미하는 것

**502 = 백엔드(NestJS)가 정상 응답을 주지 못했다는 뜻입니다.**

- 유효성 검사 **로직** 문제가 아니라, **요청이 앱까지 제대로 전달되지 않았거나**  
  **앱이 응답하지 못한 상황**입니다.
- `check-email`, `check-nickname` API는 `@Public()` 이라 인증 없이 호출 가능하며,  
  서버 코드상으로는 단순 조회만 수행합니다.

## 가능한 원인 (우선순위)

### 1. 백엔드(Node/NestJS) 프로세스가 떠 있지 않음

- 서버(ohun.kr 백엔드가 돌아가는 머신)에서 Node 앱이 종료되었거나 재시작 후 실패한 경우.
- **확인:**  
  - PM2 사용 시: `pm2 list`, `pm2 logs`  
  - systemd 사용 시: `systemctl status <서비스명>`  
  - 직접 실행 시: 해당 터미널/프로세스가 살아있는지 확인

### 2. DB 연결 실패로 앱이 기동하지 않음

- NestJS는 보통 DB 연결이 된 뒤에 HTTP 서버를 연다.
- DB(PostgreSQL 등)에 연결할 수 없으면 `bootstrap()` 단계에서 실패하거나 멈출 수 있고,  
  그 경우 **포트 리스닝 자체가 안 되어** nginx가 백엔드에 연결하지 못해 502를 반환합니다.
- **확인:**  
  - 서버 로그(PM2 로그, systemd 저널, 콘솔 출력)에 DB 연결 오류(ECONNREFUSED, timeout 등)가 있는지 확인  
  - DB 서버(192.168.132.81 등) 방화벽/보안 그룹, DB 프로세스 동작 여부 확인  
  - `DB_HOST`, `DB_PORT`, `DB_USERNAME`, `DB_PASSWORD` 등 환경 변수 값 확인

### 3. 리버스 프록시(Nginx 등) 설정 문제

- 프록시가 백엔드로 넘기는 **upstream 주소/포트**가 잘못되었거나,  
  백엔드가 **다른 포트/호스트**에서 리스닝 중인 경우.
- **확인:**  
  - Nginx 설정의 `proxy_pass`가 실제 NestJS 리스닝 주소와 일치하는지 (예: `http://127.0.0.1:3000`)  
  - `proxy_connect_timeout`, `proxy_read_timeout` 등이 너무 짧지 않은지 (예: 60초)

### 4. 백엔드가 특정 호스트에서만 리스닝

- `main.ts`에서 `host`를 `0.0.0.0`이 아닌 값으로 두면, 같은 서버의 nginx에서도 접근이 안 될 수 있음.
- 현재 코드는 `process.env.HOST ?? '0.0.0.0'`을 쓰므로, **HOST** 환경 변수가 `127.0.0.1`만으로 잡혀 있지 않은지 확인.

### 5. Redis/기타 의존성으로 기동 지연 또는 크래시

- `main.ts`에서 Redis 연결 실패 시 로그만 남기고 null로 두므로, Redis 때문에 502가 나진 않을 가능성이 높지만,  
  다른 초기화 코드에서 예외가 나면 프로세스가 죽어 502가 반복될 수 있음.
- **확인:** PM2/systemd 로그에서 기동 직후 크래시/재시작 반복 여부 확인.

## 점검 순서 (서버에서 실행)

1. **백엔드 프로세스 확인**  
   `pm2 list` 또는 `ps aux | grep node`  
   → NestJS 프로세스가 있는지, 상태가 `online`인지 확인.

2. **백엔드 로그 확인**  
   `pm2 logs` 또는 `journalctl -u <서비스명> -f`  
   → DB 연결 오류, Redis 오류, uncaught exception 등이 있는지 확인.

3. **로컬에서 백엔드 직접 호출**  
   백엔드가 돌아가는 서버에서:  
   `curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:3000/api/auth/check-nickname?nickname=test"`  
   → 200이 나오면 앱은 정상, 502/연결 실패면 앱 미기동 또는 크래시 가능성.

4. **Nginx 에러 로그**  
   `tail -f /var/log/nginx/error.log` (경로는 환경에 맞게)  
   → upstream 연결 실패, timeout 메시지가 있는지 확인.

5. **DB 연결 테스트**  
   백엔드와 같은 서버/네트워크에서 DB 포트 접속 가능 여부 확인  
   (예: `telnet 192.168.132.81 5432` 또는 DB 클라이언트로 접속).

## 정리

- **"서버에서 유효성 검사가 안 된다"**는 것은, **검증 API가 502로 실패**하기 때문입니다.
- 502는 **앱이 응답하지 못할 때** 리버스 프록시가 내는 응답이므로,  
  **앱 프로세스 기동 여부**, **DB/Redis 등 의존성**, **프록시 설정**을 위 순서대로 확인하면 됩니다.
- 코드 상 `check-nickname`은 DB를 타지 않고 `true`만 반환하고, `check-email`은 DB 조회 1회만 하므로,  
  **앱이 정상 기동만 되어 있으면** 이 두 API는 502 없이 동작하는 구조입니다.
